version: '3.8'

volumes:
    server_node_modules:
    client_node_modules:
    mongodb_data:

services:
    mongodb:
        image: mongo:latest
        container_name: mongodb
        restart: unless-stopped
        ports:
            - '27017:27017'
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=vibe_calculator

    server:
        image: node:20-alpine
        container_name: my_server
        working_dir: /app
        restart: unless-stopped
        depends_on:
            - mongodb
        volumes:
            - ./server:/app
            - server_node_modules:/app/node_modules
        environment:
            - CHOKIDAR_USEPOLLING=true
            - CHOKIDAR_INTERVAL=200
            - PORT=8080
            - MONGODB_URI=mongodb://mongodb:27017/vibe_calculator
            - JWT_SECRET=your_jwt_secret_key_change_me_in_prod
            - CORS_ORIGIN=http://localhost:8080
        ports:
            - '8080:8080'
        command: sh -c "npm install && npm run dev"

    client:
        image: node:20-alpine
        container_name: my_client
        working_dir: /app
        restart: unless-stopped
        depends_on:
            - server
        volumes:
            - ./client:/app
            - client_node_modules:/app/node_modules
        environment:
            - CHOKIDAR_USEPOLLING=true
            - CHOKIDAR_INTERVAL=200
        ports:
            - '5173:5173'
        # Vite must bind to 0.0.0.0 inside container, otherwise host can't access it
        command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
